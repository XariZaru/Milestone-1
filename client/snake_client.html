<!DOCTYPE html>

<html>
<head>
    <title>ICS 167: Multiplayer Snake Game</title>

    <style>
        #log {
            width: 495px;
            height: 150px;
        }
    </style>

</head>

<body style="font-family: Arial">
    <center>
        <center>
            <h1>ICS 167 - MULTIPLAYER SNAKE GAME</h1>
            <h4>By: Wesley Tseng, Alexander Lee, Jonathan Nguyen, Patrick Jose</h4>
        </center>    

        <!-- Server IP and Port Input Fields -->
        Player Name: <input type='text' id="player1" name="player1">
        <br/><br />
        
        Server IP: <input type='text' id='ip' name='ip'>
        Server Port: <input type='text' id='port' name='port'>
        <br/><br />

        <!-- Creates "Connect" button -->
        <button type="button" id="cntBtn" onclick="connect();">Connect</button>
        <h5></h5>

        <!-- Console-->
        <textarea style="background-color:black; color:green;" id='log' name='log' readonly='readonly'></textarea><br/>

        <!-- Creates game canvas and Javascript text -->
        <div id="game" style="display:none">
            <canvas id="canvas" width="500" height="500"></canvas>
        </div>


        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
        <script type="text/javascript" src="snake_socket.js"></script> 
        <script type="text/javascript">

            // ----------------
            // SERVER FUNCTIONS
            // ----------------
            var Server;
			var map, height, width, canvas, b_size;
			
            function log(text) {
                // Special character ! denotes regular messages from information
                if (text.charAt(0) == "!") {
                    $log = $('#log');
                    //Add text to log
                    $log.append(($log.val() ? "\n" : '') + array_text);
                    //Autoscroll
                    $log[0].scrollTop = $log[0].scrollHeight - $log[0].clientHeight;
                } else {
                    array_text = text.split(" ");
                    $log = $('#log');
                    //Add text to log
                    //Autoscroll
                    $log[0].scrollTop = $log[0].scrollHeight - $log[0].clientHeight;
					if (array_text[0] == "CLEAR")
						paint_bg();
                    else if (document.getElementById('player1').value == array_text[0]) {
						array_text.shift();
						for (var x = 0; x < array_text.length; x++) {
							var coord = array_text[x].split(",");
							paint(parseInt(coord[0]), parseInt(coord[1]), "blue", "white");
							$log.append(($log.val() ? "\n" : '') + "Moving player " + coord[0] + " " + coord[1]);
						}
                    } else if (array_text[0] != "Food") {
						array_text.shift();
						for (var x = 0; x < array_text.length; x++) {
							var coord = array_text[x].split(",");
							paint(parseInt(coord[0]), parseInt(coord[1]), "red", "white");
							$log.append(($log.val() ? "\n" : '') + "Moving player " + coord[0] + " " + coord[1]);
						}
					} else if (array_text[0] == "Food") {
						array_text.shift();
						var coord = array_text.split(",");
						$log.append(($log.val() ? "\n" : '') + "Food " + coord);
						paint(parseInt(coord[0]), parseInt(coord[1]), "green", "white");
						$log.append(($log.val() ? "\n" : '') + "Got food " + coord[0] + " " + coord[1]);
					}
                }
            }

            function send(text) {
                Server.send('message', text);
            }

            function connect() {
                log('Connecting...');
                Server = new SnakeSocket('ws://' + document.getElementById('ip').value + ':' + document.getElementById('port').value);

                $('#message').keypress(function (e) {
                    if (e.keyCode == 13 && this.value) {
                        log('You: ' + this.value);
                        send(this.value);

                        $(this).val('');
                    }
                });

                //Let the user know we're connected
                Server.bind('open', function () {
                    var gameBoard = document.getElementById('game');
                    document.getElementById("cntBtn").disabled = true;
                    log("Connected.");
                    gameBoard.style.display = "block";

                    Server.send("player1", document.getElementById('player1').value + ".Player1");
                    //Server.send("player2", document.getElementById('player2').value+".Player2");
                });

                //OH NOES! Disconnection occurred.
                Server.bind('close', function (data) {
                    document.getElementById("cntBtn").disabled = false;
                    log("Disconnected.");
                    Server.send("disconnect", "User has disconnected");
                });

                //Log any messages sent from server
                Server.bind('message', function (payload) {
                    log(payload);
                });

                Server.connect();
            }

			function paint_snakes(p1x, p1y, p2x, p2y) {
				paint_bg();
				var dir_1;
				var p1_score = 0, p2_score = 0;
				// Draws snake based on direction
				if          (dir_1 == "right")   p1x++;
				else if     (dir_1 == "left")    p1x--;
				else if     (dir_1 == "up")      p1y--;
				else if     (dir_1 == "down")    p1y++;

				// SCORE TEXT
				var p1_score_text = "Player 1 Score: " + p1_score;
				var p2_score_text = "Player 2 Score: " + p2_score;
				map.fillStyle = "black";
				map.fillText(p1_score_text, 5, height - 5);
				map.fillText(p2_score_text, width - 100, height - 5);

			}

			// Paints Cube object given coordinates and color
			function paint(x, y, f_c, s_c) {
				map.fillStyle = f_c;
				map.fillRect(x * b_size, y * b_size, b_size, b_size);
				map.strokeStyle = s_c;
				map.strokeRect(x * b_size, y * b_size, b_size, b_size);
			}

			// Paints Background of Canvvas
			function paint_bg() {
				map.fillStyle = "white";
				map.fillRect(0, 0, width, height);
				map.strokeStyle = "black";
				map.strokeRect(0, 0, width, height);
			}

			// Checks collision of Object(x,y) and array
			function chk_collision(x, y, array) {
				for (var i = 0; i < array.length; i++) {
					if (array[i].x == x && array[i].y == y) {
						return true;
					}
				}
				return false;
			}

			// Returns player1 score
			function getScore(){
				Server.send("player1score", p1_score+".P1Score");
				Server.send("player2score", p2_score+".P2Score");
			}

			// Keyboard controls for each player
			$(document).keydown(function (e) {
				var key = e.which;
				// Player 1 uses WSAD
				if (key == "65" && dir_1 != "right") dir_1 = "left";
				else if (key == "87" && dir_1 != "down") dir_1 = "up";
				else if (key == "68" && dir_1 != "left") dir_1 = "right";
				else if (key == "83" && dir_1 != "up") dir_1 = "down";
				// Player 2 uses →↑↓←
				if (key == "37" && dir_2 != "right") dir_2 = "left";
				else if (key == "38" && dir_2 != "down") dir_2 = "up";
				else if (key == "39" && dir_2 != "left") dir_2 = "right";
				else if (key == "40" && dir_2 != "up") dir_2 = "down";
			})

		$(document).ready(function () {
			$log = $('#log');
			$log.append(($log.val() ? "\n" : '') + "WUT");
			canvas = document.getElementById("canvas");
			map = canvas.getContext("2d");
			width = document.getElementById('canvas').width;
			height = document.getElementById('canvas').height;
			$log.append(($log.val() ? "\n" : '') + "WUT");
			b_size = 10;
			$log.append(($log.val() ? "\n" : '') + "WUT");
			paint_bg();
			$log.append(($log.val() ? "\n" : '') + "WUT");
            })
        </script>
    </center>
</body>

</html>
