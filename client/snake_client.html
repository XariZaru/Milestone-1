<!DOCTYPE html>

<html>
<head>
    <title>ICS 167: Multiplayer Snake Game</title>

    <!-- Size of Console Log -->
    <style>
        #log {
            width: 500px;
            height: 500px;
        }
    </style>

    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script type="text/javascript" src="snake_socket.js"></script> 
    <script type="text/javascript">
            var Server;

            function log(text) {
                $log = $('#log');
                //Add text to log
                $log.append(($log.val() ? "\n" : '') + text);
                //Autoscroll
                $log[0].scrollTop = $log[0].scrollHeight - $log[0].clientHeight;
            }

            function send(text) {
                Server.send('message', text);
            }

            function connect() {
                log('Connecting...');
                Server = new SnakeSocket('ws://' + document.getElementById('ip').value + ':' + document.getElementById('port').value);

                $('#message').keypress(function (e) {
                    if (e.keyCode == 13 && this.value) {
                        log('You: ' + this.value);
                        send(this.value);

                        $(this).val('');
                    }
                });

                //Let the user know we're connected
                Server.bind('open', function () {
                    var gameBoard = document.getElementById('game');
                    document.getElementById("cntBtn").disabled = true;
                    log("Connected.");
                    gameBoard.style.display = "block";

                    Server.send("player1", document.getElementById('player1').value + ".Player1");
                    //Server.send("player2", document.getElementById('player2').value + ".Player2");
                });

                //OH NOES! Disconnection occurred.
                Server.bind('close', function (data) {
                    document.getElementById("cntBtn").disabled = false;
                    log("Disconnected.");
                    Server.send("disconnect", "User has disconnected");
                });

                //Log any messages sent from server
                Server.bind('message', function (payload) {
                    log(payload);
                });

                Server.connect();
            }
            

        </script>
</head>

<body style="font-family: Arial">
    <center>
        <h1>ICS 167 - MULTIPLAYER SNAKE GAME</h1>
        <h4>By: Wesley Tseng, Alexander Lee, Jonathan Nguyen, Patrick Jose</h4>  
        Player: <input type='text' id="player1" name="player1"> 
        &nbsp
        <br/><br/>
        Server IP: <input type='text' id='ip' name='ip'> 
        &nbsp 
        Server Port: <input type='text' id='port' name='port'>
        <br/><br/>
        <!-- Creates "Connect" button -->
        <button type="button" id="cntBtn" onclick="connect();">Connect</button> &nbsp

        <h5></h5>

        <!-- Creates game canvas and Javascript text -->
        <div id="game" style="display:none"><canvas id="canvas" width="500" height="500"></canvas></div>

        <!-- Console-->
        <textarea style="background-color:black; color:green;" id='log' name='log' readonly='readonly'></textarea>
       
        <script type="text/javascript">
            $(document).ready(function () {
                var canvas = document.getElementById("canvas");
                var map = canvas.getContext("2d");
                var width = document.getElementById('canvas').width;
                var height = document.getElementById('canvas').height;
                var b_size = 10;
                var food;
                // Direction for each player
                var dir_1;
                var dir_2;
                // Score for each player
                var p1_score;
                var p2_score;

                // Paints background
                paint_bg();

                // Two variables, one for each player
                var snake_1;
                var snake_2;

                // Initialize
                function init() {
                    // Sets default direction to right
                    dir_1 = "right";
                    dir_2 = "right";
                    // Sets default score to 0
                    p1_score = 0;
                    p2_score = 0;
                    // Creates snake array and food object
                    create_snake();
                    create_food();


                    if (typeof game_loop != "undefined")
                    { clearInterval(game_loop); }

                    // Updates game every 60 ms
                    game_loop = setInterval(paint_snakes, 60);


                }

                init();

                function create_snake() {
                    var length = 5;
                    snake_1 = [];
                    snake_2 = [];

                    for (var i = length - 1; i >= 0; i--) {
                        snake_1.push({ x: i, y: 0 });
                    }

                    for (var i = length - 1; i >= 0; i--) {
                        snake_2.push({ x: i, y: 49 });
                    }
                }

                // Function creates food object at random (x, y) coordinate
                function create_food() {
                    food = {
                        x: Math.round(Math.random() * (width - b_size) / b_size),
                        y: Math.round(Math.random() * (height - b_size) / b_size),
                    };

                }

                function paint_snakes() {
                    paint_bg();

                    // PLAYER 1 SNAKE
                    var p1x = snake_1[0].x;
                    var p1y = snake_1[0].y;

                    if       (dir_1 == "right")  p1x++;
                    else if  (dir_1 == "left")   p1x--;
                    else if  (dir_1 == "up")     p1y--;
                    else if  (dir_1 == "down")   p1y++;

                    // Restarts game if Sna ke 1 touches wall, itself, or Snake 2
                    if (p1x == -1 || p1x == width / b_size || p1y == -1 || p1y == height / b_size || chk_collision(p1x, p1y, snake_1) || chk_collision(p1x, p1y, snake_2)) {
                        return;
                    }

                    // Snake 1 grows head if touches food
                    if (p1x == food.x && p1y == food.y) {
                        var tail_1 = { x: p1x, y: p1y };
                        p1_score++;
                        getScore();
                        create_food();
                    }
                    else {
                        var tail_1 = snake_1.pop();
                        tail_1.x = p1x;
                        tail_1.y = p1y;
                    }

                    snake_1.unshift(tail_1);

                    for (var i = 0; i < snake_1.length; i++) {
                        var p1 = snake_1[i];
                        paint(p1.x, p1.y, "blue", "white");
                    }


                    // PLAYER 2 SNAKE
                    var p2x = snake_2[0].x;
                    var p2y = snake_2[0].y;

                    if (dir_2 == "right") p2x++;
                    else if (dir_2 == "left") p2x--;
                    else if (dir_2 == "up") p2y--;
                    else if (dir_2 == "down") p2y++;

                    // Restarts game if Snake 2 touches wall, itself, or Snake 1
                    if (p2x == -1 || p2x == width / b_size || p2y == -1 || p2y == height / b_size || chk_collision(p2x, p2y, snake_1) || chk_collision(p2x, p2y, snake_2)) {
                        return;
                    }

                    // Snake 2 grows head if touches food
                    if (p2x == food.x && p2y == food.y) {
                        var tail_2 = { x: p2x, y: p2y };
                        p2_score++;
                        create_food();
                        getScore();
                    }
                    else {
                        var tail_2 = snake_2.pop();
                        tail_2.x = p2x;
                        tail_2.y = p2y;
                    }

                    snake_2.unshift(tail_2);

                    for (var i = 0; i < snake_2.length; i++) {
                        var p2 = snake_2[i];
                        paint(p2.x, p2.y, "red", "white");
                    }


                    // FOOD PARTICLE
                    paint(food.x, food.y, "green", "white");


                    // SCORE TEXT
                    var p1_score_text = "Player 1 Score: " + p1_score;
                    var p2_score_text = "Player 2 Score: " + p2_score;
                    map.fillStyle = "black";
                    map.fillText(p1_score_text, 5, height - 5);
                    map.fillText(p2_score_text, width - 100, height - 5);

                }

                // Paints desired object based on inputted dimensins and color
                function paint(x, y, f_c, s_c) {
                    map.fillStyle = f_c;
                    map.fillRect(x * b_size, y * b_size, b_size, b_size);
                    map.strokeStyle = s_c;
                    map.strokeRect(x * b_size, y * b_size, b_size, b_size);
                }

                // Paints the Board of the Game
                function paint_bg() {
                    map.fillStyle = "white";
                    map.fillRect(0, 0, width, height);
                    map.strokeStyle = "black";
                    map.strokeRect(0, 0, width, height);
                }

                // Checks collision of Object(x,y) and array
                function chk_collision(x, y, array) {
                    for (var i = 0; i < array.length; i++) {
                        if (array[i].x == x && array[i].y == y) {
                            return true;
                        }
                    }
                    return false;
                }

                // Returns player's score
                function getScore(){
                    Server.send("player1score", p1_score+".P1Score");
                    Server.send("player2score", p2_score+".P2Score");
                }

                // Compares Player's 1 Score and Player's 2 Score to Determine the Winner
                function compareScore(p1Score, p2Score) {


                }

                // Keyboard controls for each player
                $(document).keydown(function (e) {
                    var key = e.which;
                    // Player 1 uses WSAD
                    if (key == "65" && dir_1 != "right") dir_1 = "left";
                    else if (key == "87" && dir_1 != "down") dir_1 = "up";
                    else if (key == "68" && dir_1 != "left") dir_1 = "right";
                    else if (key == "83" && dir_1 != "up") dir_1 = "down";
                    // Player 2 uses →↑↓←
                    if (key == "37" && dir_2 != "right") dir_2 = "left";
                    else if (key == "38" && dir_2 != "down") dir_2 = "up";
                    else if (key == "39" && dir_2 != "left") dir_2 = "right";
                    else if (key == "40" && dir_2 != "up") dir_2 = "down";
                })
            })
        </script>
    </center>
</body>

</html>
